
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Programming with futures: patterns and anti-patterns</title>
    <meta name="description" content="">
    <meta name="author" content="Jason Liszka">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1&amp;v=2" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygment.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <div class="row-fluid">
            <div class="span9 offset1">
              <a class="brand" href="/">A Gentleman and a Scala</a>
              <ul class="nav">
                
                
                


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="row-fluid">
  <div class="span9 offset1 post-content post-spacer"></div>
</div>
<div class="row-fluid post-full">
  <div class="span9 offset1 post-content">
    <div class="page-header">
      <h1>Programming with futures: patterns and anti-patterns </h1>
    </div>
    <div class="date">
      <span>03 June 2014</span>
    </div>
    <div class="content">
      
<p>Twitter’s Future library is a beautiful abstraction for dealing with concurrency. However, there are
code patterns that seem natural or innocuous but can cause real trouble in production systems. This short
article outlines a few of the easiest traps to fall into.</p>

<h3 id="an-example">An example</h3>

<p>Below is a method from a fictional web application that registers a user by calling the Foursquare API
to get the user’s profile info, their friend graph and their recent check-ins.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">registerUser</span><span class="o">(</span><span class="n">token</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">api</span> <span class="k">=</span> <span class="nc">FoursquareApi</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Future</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">apiUser</span><span class="o">.</span><span class="n">friendIDs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">api</span><span class="o">.</span><span class="n">getUserF</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">apiCheckinsF</span><span class="o">(</span><span class="n">apiUser</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">,</span> <span class="n">categoryies</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCategory</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCheckin</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">createDBUser</span><span class="o">(</span>
      <span class="n">user</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">,</span>
      <span class="n">friends</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">],</span>
      <span class="n">checkins</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCheckin</span><span class="o">])</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="o">(...)</span>
  <span class="o">}</span>

  <span class="k">for</span> <span class="o">{</span>
    <span class="n">apiUser</span> <span class="k">&lt;-</span> <span class="n">api</span><span class="o">.</span><span class="n">getSelfF</span><span class="o">()</span>
    <span class="n">apiCategories</span> <span class="k">&lt;-</span> <span class="n">api</span><span class="o">.</span><span class="n">getCategoriesF</span><span class="o">()</span>
    <span class="n">apiFriends</span> <span class="k">&lt;-</span> <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">)</span>
    <span class="n">apiCheckins</span> <span class="k">&lt;-</span> <span class="n">apiCheckinsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiCategories</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">createDBUser</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiFriends</span><span class="o">,</span> <span class="n">apiCheckins</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

<p>There are some problems with this code.</p>

<!-- more -->

<h3 id="anti-pattern-1-blocking-in-a-yield-or-a-map">Anti-pattern #1: Blocking in a yield or a map</h3>

<p>The last part of the <code>for</code>-comprehension desugars to</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">apiCheckinsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiCategories</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">apiCheckins</span> <span class="k">=&gt;</span> 
  <span class="n">createDBUser</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiFriends</span><span class="o">,</span> <span class="n">apiCheckins</span><span class="o">))</span></code></pre></div>

<p>The problem here is that <code>createDBUser</code> makes a blocking call to the database.
You should never do blocking work in <code>map</code> on a Future.
Every Future runs in a thread pool that is (hopefully) tuned for a particular purpose.
Code inside the <code>map</code> (generally) runs on the thread that completes the Future.
So you’re putting work in a thread pool that wasn’t designed to handle that work.</p>

<p>Furthermore, when you’re dealing with Futures composed from other Futures, it’s often hard to tell by inspection which
Future will be the last to complete (and whose thread pool will run the <code>map</code> code).
It’s frequently not the “outermost” Future. For example:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">outermostFuture</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">runsInThreadPoolA</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">val</span> <span class="n">runsInThreadPoolB</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">a</span> <span class="k">&lt;-</span> <span class="n">runsInThreadPoolA</span>
    <span class="n">b</span> <span class="k">&lt;-</span> <span class="n">runsInThreadPoolB</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>
<span class="o">}</span>

<span class="n">outermostFuture</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="cm">/* where do I run?? */</span><span class="o">)</span></code></pre></div>

<p>It’s also possible that the Future completes <em>before</em> you call <code>map</code> — in which case the work inside the <code>map</code>
happens in the main thread. This is bad if your callers expect you to to return instantly with a Future.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">thisActuallyBlocks</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">anIntF</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
  <span class="c1">// ... some more stuff ...</span>
  <span class="n">anIntF</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">somethingThatBlocks</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
<span class="o">}</span></code></pre></div>

<p>It’s also possible to cause a deadlock (and yes we’ve seen this in production) if the code inside the <code>map</code>
calls <code>Await</code> on another thread in the same thread pool — but again, it’s hard to know which thread pool that is.</p>

<p>So instead, set up your own thread pool for blocking work:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">future</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="n">pool</span> <span class="k">=</span> <span class="nc">FuturePool</span><span class="o">(</span><span class="nc">Executors</span><span class="o">.</span><span class="n">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">))</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">pool</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

<p>And use it like this:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">createDBUserF</span><span class="o">(</span>
    <span class="n">user</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">,</span>
    <span class="n">friends</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">],</span>
    <span class="n">checkins</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCheckin</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="n">future</span> <span class="o">{</span>
  <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="o">(...)</span>
<span class="o">}</span>

<span class="k">for</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="n">user</span> <span class="k">&lt;-</span> <span class="n">createDBUserF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiFriends</span><span class="o">,</span> <span class="n">apiCheckins</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">user</span></code></pre></div>

<p>This now desugars to</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">createDBUserF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">friends</span><span class="o">,</span> <span class="n">checkins</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">user</span> <span class="k">=&gt;</span> <span class="n">user</span><span class="o">)</span></code></pre></div>

<p>which is safe.</p>

<p>So ALWAYS <code>yield</code> a plain value or a simple computation. If you have blocking work, wrap it in a ThreadPool-backed
Future and <code>flatMap</code> it.</p>

<p>It’s worth noting that in the Scala-native Future library (<code>scala.concurrent.Future</code>), you must supply an implicit
or explicit execution context when you create a Future. That way, you do have control over where your code executes, so
the above warnings about <code>map</code> do not apply.</p>

<h3 id="anti-pattern-2-too-much-parallelism">Anti-pattern #2: Too much parallelism</h3>

<p>The method <code>apiFriendsF</code> creates a future for each item in a list of user IDs and collects the results into a single 
Future:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nc">Future</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">apiUser</span><span class="o">.</span><span class="n">friendIDs</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">api</span><span class="o">.</span><span class="n">getUserF</span><span class="o">))</span>
<span class="o">}</span></code></pre></div>

<p>But this is too much parallelism! You’ll flood the thread pool with a ton of simultaneous work. Some network or database
drivers don’t even allow more than a certain number of concurrent connections, and you’ll get a bunch of exceptions, and
you will not have a good day. A better way to do it is to limit how much you are doing in parallel.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">future</span><span class="o">.</span><span class="n">groupedCollect</span><span class="o">(</span><span class="n">apiUser</span><span class="o">.</span><span class="n">friendIDs</span><span class="o">,</span> <span class="mi">5</span><span class="o">)(</span><span class="n">api</span><span class="o">.</span><span class="n">getUserF</span><span class="o">)</span>
<span class="o">}</span></code></pre></div>

<p>The <code>groupedCollect</code> helper method can be impemented as follows:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">future</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">groupedCollect</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">xs</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">par</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">B</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">bsF</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">B</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="nc">Seq</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
    <span class="n">xs</span><span class="o">.</span><span class="n">grouped</span><span class="o">(</span><span class="n">par</span><span class="o">).</span><span class="n">foldLeft</span><span class="o">(</span><span class="n">bsF</span><span class="o">){</span> <span class="k">case</span> <span class="o">(</span><span class="n">bsF</span><span class="o">,</span> <span class="n">group</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">bs</span> <span class="k">&lt;-</span> <span class="n">bsF</span>
        <span class="n">xs</span> <span class="k">&lt;-</span> <span class="nc">Future</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="o">))</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">bs</span> <span class="o">++</span> <span class="n">xs</span>
    <span class="o">}}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>The <code>par</code> parameter lets you specify how much work you want done in parallel. For example, if you specify 5, it will
take 5 items from the list, do them all in parallel, and wait for them to complete before moving on to the next 5 items.</p>

<p>This can be mitigated a different way, by configuring a thread pool with a maximum number of threads, and making sure
that all database or network calls go through this pool. This has the advantage of limiting parallelism application-wide,
rather than just at a given call site. It still might be a good idea to limit parallelism at an individual call
site to prevent it from crowding out other work.</p>

<h3 id="anti-pattern-3-not-enough-parallelism">Anti-pattern #3: Not enough parallelism</h3>

<p>This code invokes <code>api.getSelfF()</code> and <code>api.getCategoriesF()</code> sequentially when they could be run in parallel:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="n">apiUser</span> <span class="k">&lt;-</span> <span class="n">api</span><span class="o">.</span><span class="n">getSelfF</span><span class="o">()</span>
  <span class="n">apiCategories</span> <span class="k">&lt;-</span> <span class="n">api</span><span class="o">.</span><span class="n">getCategoriesF</span><span class="o">()</span>
  <span class="o">...</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">...</span></code></pre></div>

<p>It desugars to</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">api</span><span class="o">.</span><span class="n">getSelfF</span><span class="o">().</span><span class="n">flatMap</span><span class="o">(</span><span class="n">apiUser</span> <span class="k">=&gt;</span>
  <span class="n">api</span><span class="o">.</span><span class="n">getCategoriesF</span><span class="o">().</span><span class="n">flatMap</span><span class="o">(</span><span class="n">apiCategories</span> <span class="k">=&gt;</span>
    <span class="o">...))</span></code></pre></div>

<p>So one waits for the other even though it doesn’t need to. The fix is to invoke the methods outside of the
<code>for</code>-comprehension.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">apiUserF</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">]</span> <span class="k">=</span> <span class="n">api</span><span class="o">.</span><span class="n">getSelfF</span><span class="o">()</span>
<span class="k">val</span> <span class="n">apiCategoriesF</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCategory</span><span class="o">]]</span> <span class="k">=</span> <span class="n">api</span><span class="o">.</span><span class="n">getCategoriesF</span><span class="o">()</span>

<span class="o">...</span>

<span class="k">for</span> <span class="o">{</span>
  <span class="n">apiUser</span> <span class="k">&lt;-</span> <span class="n">apiUserF</span>
  <span class="n">apiCategories</span> <span class="k">&lt;-</span> <span class="n">apiCategoriesF</span>
  <span class="o">...</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">...</span></code></pre></div>

<p>Likewise, we have:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="n">apiFriends</span> <span class="k">&lt;-</span> <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">)</span>
  <span class="n">apiCheckins</span> <span class="k">&lt;-</span> <span class="n">apiCheckinsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiCategories</span><span class="o">)</span>
  <span class="o">...</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">...</span></code></pre></div>

<p>These two can also be done in parallel. Write it this way instead:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">for</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="o">(</span><span class="n">apiFriends</span><span class="o">,</span> <span class="n">apiCheckins</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="nc">Future</span><span class="o">.</span><span class="n">join</span><span class="o">(</span>
    <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">)</span>
    <span class="n">apiCheckinsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiCategories</span><span class="o">))</span>
  <span class="o">...</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">...</span></code></pre></div>

<p>The <code>join</code> method runs multiple Futures in parallel and collects their results in a tuple.
It also explicitly documents that the two calls will happen in parallel.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Here’s what we ended up with:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">registerUser</span><span class="o">(</span><span class="n">token</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">api</span> <span class="k">=</span> <span class="nc">FoursquareApi</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">apiUserF</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">]</span> <span class="k">=</span> <span class="n">api</span><span class="o">.</span><span class="n">getSelfF</span><span class="o">()</span>

  <span class="k">val</span> <span class="n">apiCategoriesF</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCategory</span><span class="o">]]</span> <span class="k">=</span> <span class="n">api</span><span class="o">.</span><span class="n">getCategoriesF</span><span class="o">()</span>

  <span class="k">def</span> <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">future</span><span class="o">.</span><span class="n">groupedCollect</span><span class="o">(</span><span class="n">apiUser</span><span class="o">.</span><span class="n">friendIDs</span><span class="o">,</span> <span class="mi">5</span><span class="o">)(</span><span class="n">api</span><span class="o">.</span><span class="n">getUserF</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">apiCheckinsF</span><span class="o">(</span><span class="n">apiUser</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">,</span> <span class="n">categoryies</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCategory</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCheckin</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">createDBUserF</span><span class="o">(</span>
      <span class="n">user</span><span class="k">:</span> <span class="kt">ApiUser</span><span class="o">,</span>
      <span class="n">friends</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiUser</span><span class="o">],</span>
      <span class="n">checkins</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ApiCheckin</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="n">future</span> <span class="o">{</span>
    <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="o">(...)</span>
  <span class="o">}</span>

  <span class="k">for</span> <span class="o">{</span>
    <span class="n">apiUser</span> <span class="k">&lt;-</span> <span class="n">apiUserF</span>
    <span class="n">apiCategories</span> <span class="k">&lt;-</span> <span class="n">apiCategoriesF</span>
    <span class="o">(</span><span class="n">apiFriends</span><span class="o">,</span> <span class="n">apiCheckins</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="nc">Future</span><span class="o">.</span><span class="n">join</span><span class="o">(</span>
      <span class="n">apiFriendsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">)</span>
      <span class="n">apiCheckinsF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiCategories</span><span class="o">))</span>
    <span class="n">user</span> <span class="k">&lt;-</span> <span class="n">createDBUserF</span><span class="o">(</span><span class="n">apiUser</span><span class="o">,</span> <span class="n">apiFriends</span><span class="o">,</span> <span class="n">apiCheckins</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">user</span>
<span class="o">}</span></code></pre></div>

<p>Things to note here:</p>

<ol>
  <li>Nested methods take plain values and return Futures, for great <code>flatMap</code>ing.</li>
  <li>All the work is set up ahead of time via <code>val</code>s and nested methods.</li>
  <li>Everything is “glued” together with a <code>for</code>-comprehension at the end.</li>
  <li>Parallelism and dependencies are made explicit in the <code>for</code>-comprehension.</li>
  <li>Blocking work is explicitly wrapped in a thread pool.</li>
</ol>


    </div>

  

  


  <div style="float: right; margin-top: 5px">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jliszka.github.io/2014/06/03/programming-with-futures.html" data-text="Programming with futures: patterns and anti-patterns" data-via="jliszka">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>




  
    <div style="clear: both"></div>

    <hr>
    <div class="navigation">
    
      <span class="prev"><a href="/2014/01/30/good-tech-lead-bad-tech-lead.html" title="Good Tech Lead, Bad Tech Lead">&larr; Good Tech Lead, Bad Tech Lead</a></span>
    
    
      <span class="next"><a href="/2014/07/12/is-the-nba-draft-rigged.html" title="Is the NBA draft rigged?">Is the NBA draft rigged? &rarr;</a></span>
    
      <div style="clear: both"></div>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jliszka'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>

  <div class="span2 sidebar">
    <a href="/"><div id="photo"></div></a>
    <div id="bio">
      <b>Jason Liszka</b><br/>
      <i>Engineer at Slack NYC, CMU alum, Scala fan, new father</i>
    </div>
    <h4>Popular posts</h4>
    <ul>
      <li><a href="/2013/10/01/how-traffic-actually-works.html">How traffic actually works</a></li>
      <li><a href="/2013/08/12/a-frequentist-approach-to-probability.html">A frequentist approach to probability</a></li>
      <li><a href="/2013/10/24/exact-numeric-nth-derivatives.html">Exact numeric nth derivatives</a></li>
      <li><a href="/2013/10/31/infinite-lazy-polynomials.html">Infinite lazy polynomials</a></li>
    </ul>

    <h4>Recent posts</h4>
    <ul>
      
        <li><a href="/2014/07/31/the-quantum-eraser.html">The quantum eraser demystified</a></li>
      
        <li><a href="/2014/07/12/is-the-nba-draft-rigged.html">Is the NBA draft rigged?</a></li>
      
        <li><a href="/2014/06/03/programming-with-futures.html">Programming with futures: patterns and anti-patterns</a></li>
      
        <li><a href="/2014/01/30/good-tech-lead-bad-tech-lead.html">Good Tech Lead, Bad Tech Lead</a></li>
      
        <li><a href="/2013/12/18/bayesian-networks-and-causality.html">Bayesian networks and causality</a></li>
      
    </ul>

    <a href="https://twitter.com/jliszka" class="twitter-follow-button" data-show-count="false" data-size="large" data-show-screen-name="false">Follow @jliszka</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2016 Jason Liszka
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-42567355-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>

